name: Full Stack Deployment

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend'
        type: boolean
        default: true
      deploy_frontend:
        description: 'Deploy Frontend'
        type: boolean
        default: true

env:
  AZURE_RESOURCE_GROUP: 'iac-infraengine-rg'
  CONTAINER_REGISTRY_NAME: 'iacstudioregistry'

jobs:
  # Trigger backend deployment if needed
  backend-deployment:
    name: Backend Deployment
    if: github.event.inputs.deploy_backend != 'false'
    uses: ./.github/workflows/backend-deploy.yml
    secrets: inherit

  # Trigger frontend deployment after backend is ready
  frontend-deployment:
    name: Frontend Deployment
    needs: backend-deployment
    if: always() && (github.event.inputs.deploy_frontend != 'false')
    uses: ./.github/workflows/frontend-deploy.yml
    with:
      backend_url: ${{ needs.backend-deployment.outputs.backend-url || 'https://iac-infraengine-backend.azurecontainerapps.io' }}
    secrets: inherit

  # Final validation
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-deployment, frontend-deployment]
    if: success() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Wait for all deployments
        run: sleep 60

      - name: Test Backend-Frontend Integration
        run: |
          BACKEND_URL="${{ needs.backend-deployment.outputs.backend-url || 'https://iac-infraengine-backend.azurecontainerapps.io' }}"
          FRONTEND_URL="https://imohweb.github.io/Malta-Business-Indexer"
          
          echo "Testing backend API..."
          curl -f "$BACKEND_URL/health" || exit 1
          
          echo "Testing frontend accessibility..."
          curl -f "$FRONTEND_URL" || exit 1
          
          echo "ğŸ‰ Integration tests passed!"

  notify-completion:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [integration-test]
    if: success()
    steps:
      - name: Success Notification
        run: |
          echo "ğŸš€ Full stack deployment completed successfully!"
          echo ""
          echo "ğŸŒ Frontend: https://imohweb.github.io/Malta-Business-Indexer"
          echo "ğŸ”— Backend: ${{ needs.backend-deployment.outputs.backend-url || 'https://iac-infraengine-backend.azurecontainerapps.io' }}"
          echo "ğŸ“¦ Resource Group: ${{ env.AZURE_RESOURCE_GROUP }}"
          echo ""
          echo "The Malta Business Indexer is now live! ğŸ‰"